---
title: "R Notebook"
output: html_notebook
---

# Creating a 'cancerous' annotation

```{r}
# Create new annotation for cancerous / not cancerous
# map boolean value to cells whether the are cancerous or not
cancerous_map <- c(
  "Stromal" = FALSE,
  "Macrophages_1" = FALSE,
  "Perivascular-Like" = FALSE,
  "Myoepi_ACTA2+" = FALSE,
  "CD4+_T_Cells" = FALSE,
  "DCIS 1" = TRUE,
  "Prolif_Invasive_Tumor" = TRUE,
  "Invasive_Tumor" = TRUE,
  "CD8+_T_Cells" = FALSE,
  "Endothelial" = FALSE,
  "Macrophages_2" = FALSE,
  "DCIS 2" = TRUE,
  "B_Cells" = FALSE,
  "Stromal_&_T_Cell_Hybrid" = FALSE,
  "T_Cell_&_Tumor_Hybrid" = TRUE,
  "IRF7+_DCs" = FALSE,
  "Mast_Cells" = FALSE,
  "LAMP3+_DCs" = FALSE,
  "Myoepi_KRT15+" = FALSE,
  "Unlabeled" = FALSE
)

# Add cancerous label to metadata
# Create a new column by matching annotations to your map
ISS_obj$Cancerous <- unname(cancerous_map[ISS_obj$Annotation])

# Verify
ISS_obj@meta.data %>%
  group_by(Annotation) %>%
  summarise(
    Count = n(),
    Cancerous = unique(Cancerous)
  )

# Add Cancerous info to cells dataframe
cells$Cancerous <- ISS_obj$Cancerous
```

```{r}
intersecting_genes <- intersect()
```

```{r}
fit_lda <- (tumour_type ~ ., )

```

# 0.2.2
```{r, fig.width=7.87, dpi=300, dev='tiff', out.width='100%'}
# Analysis of Cluster Distribution Across Tumor Depth Bins

# Filter to invasive tumor cells with both cluster and depth info
invasive_with_depth <- iss_meta[iss_meta$Annotation == "Invasive_Tumor" & 
                               !is.na(iss_meta$cluster) & 
                               !is.na(iss_meta$tumour_depth), ]

# Create depth bins
invasive_with_depth$depth_bin <- cut(
  invasive_with_depth$tumour_depth,
  breaks = c(-Inf, 0, 50, 100, 150, 200, Inf),
  labels = c("Surface (0)", "0-50", "50-100", "100-150", "150-200", "200+"),
  right = TRUE
)

# 1. Cross-tabulation: Clusters vs Depth Bins
cluster_depth_table <- table(invasive_with_depth$cluster, invasive_with_depth$depth_bin)
print("=== Cell Counts: Clusters vs Depth Bins ===")
print(cluster_depth_table)
print("\n")

# 2. Percentage of each cluster within each depth bin (row percentages)
cluster_depth_pct_row <- prop.table(cluster_depth_table, margin = 1) * 100
print("=== Row %: Distribution of each cluster across depth bins ===")
print(round(cluster_depth_pct_row, 1))
print("\n")

# 3. Percentage of each depth bin by cluster (column percentages)
cluster_depth_pct_col <- prop.table(cluster_depth_table, margin = 2) * 100
print("=== Column %: Composition of each depth bin by cluster ===")
print(round(cluster_depth_pct_col, 1))
print("\n")

# 4. Statistical test: Chi-square test
chi_test <- chisq.test(cluster_depth_table)
print("=== Chi-square Test for Independence ===")
print(paste("Chi-square =", round(chi_test$statistic, 2)))
print(paste("p-value =", format(chi_test$p.value, scientific = TRUE)))
print("\n")

# 5. Identify clusters with unique depth preferences
print("=== Clusters with Depth Preferences (>50% in any single bin) ===")
for (i in 1:nrow(cluster_depth_pct_row)) {
  cluster_name <- rownames(cluster_depth_pct_row)[i]
  max_pct <- max(cluster_depth_pct_row[i, ])
  max_bin <- colnames(cluster_depth_pct_row)[which.max(cluster_depth_pct_row[i, ])]
  
  if (max_pct > 50) {
    print(paste("Cluster", cluster_name, ":", round(max_pct, 1), 
                "% in bin", max_bin))
  }
}
print("\n")

# 6. Summary statistics by cluster
print("=== Mean Tumor Depth by Cluster ===")
depth_by_cluster <- aggregate(tumour_depth ~ cluster, 
                               data = invasive_with_depth, 
                               FUN = function(x) c(mean = mean(x), 
                                                   median = median(x), 
                                                   sd = sd(x)))
print(depth_by_cluster)
print("\n")

# 7. Visualization 1: Heatmap of cluster distribution
library(ggplot2)
library(reshape2)

heatmap_data <- melt(cluster_depth_pct_row)
colnames(heatmap_data) <- c("Cluster", "Depth_Bin", "Percentage")

p1 <- ggplot(heatmap_data, aes(x = Depth_Bin, y = Cluster, fill = Percentage)) +
  geom_tile(color = "white") +
  geom_text(aes(label = round(Percentage, 1)), size = 3) +
  scale_fill_gradient2(low = "white", mid = "lightblue", high = "darkblue", 
                       midpoint = 50, limits = c(0, 100)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right") +
  labs(title = "Cluster Distribution Across Tumor Depth Bins",
       subtitle = "Percentage of each cluster in each depth bin (row %)",
       x = "Tumor Depth Bin", y = "Cluster", fill = "% of Cluster")

print(p1)

# 8. Visualization 2: Stacked bar chart
p2 <- ggplot(invasive_with_depth, aes(x = depth_bin, fill = cluster)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_viridis_d(option = "turbo") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right") +
  labs(title = "Cluster Composition Within Each Depth Bin",
       x = "Tumor Depth Bin", y = "Proportion", fill = "Cluster")

print(p2)

# 9. Visualization 3: Box plots
p3 <- ggplot(invasive_with_depth, aes(x = cluster, y = tumour_depth, fill = cluster)) +
  geom_boxplot(alpha = 0.7) +
  scale_fill_viridis_d(option = "turbo") +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Tumor Depth Distribution by Cluster",
       x = "Cluster", y = "Tumor Depth")

print(p3)

# 10. Visualization 4: Violin plots with data points
p4 <- ggplot(invasive_with_depth, aes(x = cluster, y = tumour_depth, fill = cluster)) +
  geom_violin(alpha = 0.5) +
  geom_jitter(alpha = 0.1, size = 0.5, width = 0.2) +
  scale_fill_viridis_d(option = "turbo") +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Tumor Depth Distribution by Cluster (with individual cells)",
       x = "Cluster", y = "Tumor Depth")

print(p4)
```



```{r, fig.width=7.87, dpi=300, dev='tiff', out.width='100%'}
# Analysis of Cluster Distribution: Surface vs Core

# Filter to invasive tumor cells with both cluster and surface_class info
invasive_classified <- iss_meta[iss_meta$Annotation == "Invasive_Tumor" & 
                               !is.na(iss_meta$cluster) & 
                               iss_meta$surface_class %in% c("Surface", "Core"), ]

# 1. Cross-tabulation: Clusters vs Surface/Core
cluster_location_table <- table(invasive_classified$cluster, invasive_classified$surface_class)
print("=== Cell Counts: Clusters vs Surface/Core ===")
print(cluster_location_table)
print("\n")

# 2. Percentage of each cluster in Surface vs Core (row percentages)
cluster_location_pct_row <- prop.table(cluster_location_table, margin = 1) * 100
print("=== Row %: Distribution of each cluster between Surface and Core ===")
print(round(cluster_location_pct_row, 1))
print("\n")

# 3. Percentage composition of Surface/Core by cluster (column percentages)
cluster_location_pct_col <- prop.table(cluster_location_table, margin = 2) * 100
print("=== Column %: Cluster composition of Surface vs Core ===")
print(round(cluster_location_pct_col, 1))
print("\n")

# 4. Statistical test: Chi-square test
chi_test <- chisq.test(cluster_location_table)
print("=== Chi-square Test for Independence ===")
print(paste("Chi-square =", round(chi_test$statistic, 2)))
print(paste("p-value =", format(chi_test$p.value, scientific = TRUE)))
print("\n")

# 5. Identify clusters with strong location preferences
print("=== Clusters with Location Preferences (>60% in Surface or Core) ===")
for (i in 1:nrow(cluster_location_pct_row)) {
  cluster_name <- rownames(cluster_location_pct_row)[i]
  surface_pct <- cluster_location_pct_row[i, "Surface"]
  core_pct <- cluster_location_pct_row[i, "Core"]
  
  if (surface_pct > 60) {
    print(paste("Cluster", cluster_name, ": Surface-enriched (", 
                round(surface_pct, 1), "%)"))
  } else if (core_pct > 60) {
    print(paste("Cluster", cluster_name, ": Core-enriched (", 
                round(core_pct, 1), "%)"))
  }
}
print("\n")

# 6. Visualization 1: Grouped bar chart showing cluster distribution
library(ggplot2)
library(reshape2)

bar_data <- melt(cluster_location_pct_row)
colnames(bar_data) <- c("Cluster", "Location", "Percentage")

p1 <- ggplot(bar_data, aes(x = Cluster, y = Percentage, fill = Location)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label = round(Percentage, 1)), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5, size = 3) +
  scale_fill_manual(values = c("Surface" = "#C90065", "Core" = "#fac0da")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5),
        legend.position = "top") +
  labs(title = "Cluster Distribution: Surface vs Core",
       subtitle = "Percentage of each cluster in Surface vs Core locations",
       x = "Cluster", y = "Percentage (%)", fill = "Location")

print(p1)

# 7. Visualization 2: Stacked bar chart showing composition
p2 <- ggplot(invasive_classified, aes(x = surface_class, fill = cluster)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_viridis_d(option = "turbo") +
  theme_minimal() +
  theme(legend.position = "right") +
  labs(title = "Cluster Composition: Surface vs Core",
       subtitle = "Relative proportion of each cluster within Surface and Core regions",
       x = "Location", y = "Proportion", fill = "Cluster")

print(p2)

# 8. Visualization 3: Absolute counts
p3 <- ggplot(invasive_classified, aes(x = surface_class, fill = cluster)) +
  geom_bar(position = "dodge") +
  scale_fill_viridis_d(option = "turbo") +
  theme_minimal() +
  theme(legend.position = "right") +
  labs(title = "Absolute Cell Counts by Cluster and Location",
       x = "Location", y = "Cell Count", fill = "Cluster")

print(p3)

# 9. Visualization 4: Heatmap
heatmap_data <- melt(cluster_location_pct_row)
colnames(heatmap_data) <- c("Cluster", "Location", "Percentage")

p4 <- ggplot(heatmap_data, aes(x = Location, y = Cluster, fill = Percentage)) +
  geom_tile(color = "white", linewidth = 1) +
  geom_text(aes(label = round(Percentage, 1)), size = 5, fontface = "bold") +
  scale_fill_gradient2(low = "white", mid = "lightblue", high = "darkblue", 
                       midpoint = 50, limits = c(0, 100)) +
  theme_minimal() +
  theme(axis.text = element_text(size = 12),
        legend.position = "right",
        panel.grid = element_blank()) +
  labs(title = "Heatmap: Cluster Localization",
       subtitle = "Percentage of each cluster in Surface vs Core",
       x = "Location", y = "Cluster", fill = "% of Cluster")

print(p4)

# 10. Summary statistics
print("=== Summary: Cell counts by cluster and location ===")
summary_table <- addmargins(cluster_location_table)
print(summary_table)
```



