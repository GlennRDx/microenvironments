---
output:
  pdf_document:
    latex_engine: xelatex
geometry: margin=0.2in
---

```{r setup, include=FALSE, message = FALSE, warning = FALSE}
# Load config.R
source("config.R") 

# Set root directory using the variable from config
knitr::opts_knit$set(root.dir = data_dir)

# Load libraries
library(MASS)
library(dplyr)
library(data.table)
library(Seurat)
library(ggplot2)
library(tidyverse)
library(data.table)
```

# load pretrained LDA model & list of genes used

```{r}
fit_lda <- readRDS("janesick_2023/processed/fit_lda_final.RDS")
shared_genes <- readRDS("janesick_2023/processed/shared_genes.RDS")
genes_to_keep <- readRDS("janesick_2023/processed/genes_to_keep_final.RDS")
wts_obj <- readRDS("janesick_2023/raw_clean/wts_obj_clean.RDS")
```

# Create new WTS object with quantile matched data

```{r}
wts_expr_clean <- fread("janesick_2023/raw/scRNAseq_data_quantile_matched.txt") %>% as.data.frame()
rownames(wts_expr_clean) <- wts_expr_clean$V1
wts_expr_clean$V1 <- NULL

# wts_meta_clean <- readRDS("janesick_2023/raw_clean/wts_meta_clean.RDS") %>% as.data.frame()
# wts_obj = CreateSeuratObject(counts = wts_expr_clean, meta.data = wts_meta_clean)
```

```{r}
# Remove genes which are not shared between ISS and WTS
wts_obj <- subset(wts_obj, features = shared_genes)
```


```{r}
# covert quantile matched counts to sparse matrix
counts_matrix_sparse <- as(as.matrix(wts_expr_clean), "dgCMatrix")

# Replace old RAW counts with quantile matched sparse matrix
wts_obj[["RNA"]] <- SetAssayData(object = wts_obj[["RNA"]], 
                             layer = "counts", 
                             new.data = counts_matrix_sparse)
```

# Check gene counts of random genes
```{r}
# raw_counts <- GetAssayData(wts_obj_invasive, assay = "RNA", layer = "counts")
# raw_exp <- as.matrix(t(raw_counts))
# raw_df <- as.data.frame(raw_exp)
# 
# p <- ggplot(raw_df, aes(x=ABCC11)) +
#   geom_density()
# p

```


# Filter to invasive tumour cells only

```{r}
wts_obj_invasive <- subset(wts_obj, subset = Annotation %in% "Invasive_Tumor")
```

# Normalise
```{r}
wts_obj_invasive <- NormalizeData(wts_obj_invasive)
wts_obj_invasive <- ScaleData(wts_obj_invasive)
```
# Extract normalised count matrix in preparation for prediction
```{r}
inv_tumour_expr <- as.data.frame(t(as.matrix(LayerData(wts_obj_invasive, layer = "data"))))
```


# Align genes between two data sets
```{r}
genes_in_scrna <- intersect(genes_to_keep, colnames(inv_tumour_expr))
cat("\nGene alignment summary:\n")
cat("Genes in LDA model:", length(genes_to_keep), "\n")
cat("Genes found in scRNA-seq:", length(genes_in_scrna), "\n")
# Create expression matrix with only available genes
expr_df_aligned <- inv_tumour_expr[, genes_to_keep]
# reorder columns to match the training data
expr_df_aligned <- expr_df_aligned %>%
  dplyr::select(all_of(genes_to_keep))
```

# Apply LDA model to predict surface / core labels
```{r}
# Make predictions
lda_predictions <- predict(fit_lda, newdata = expr_df_aligned)

# Extract predicted classes and posterior probabilities
predicted_classes <- lda_predictions$class
posterior_probs <- lda_predictions$posterior
lda_scores <- lda_predictions$x

# Create results dataframe
results_df <- data.frame(
  cell_id = rownames(expr_df_aligned),
  predicted_class = predicted_classes,
  prob_core = posterior_probs[, "Core"],
  prob_surface = posterior_probs[, "Surface"],
  LD1 = lda_scores[, 1],
  annotation = wts_obj_invasive$Annotation[match(rownames(expr_df_aligned), colnames(wts_obj_invasive))],
  stringsAsFactors = FALSE
)

# results_df_filtered <- results_df %>%
  # filter(LD1 < -0.5 | LD1 > -0.2)

# identify the ma probability for each cell and then filter if less than the prob_threshold
results_df <- results_df %>%
  mutate(max_prob = pmax(prob_core, prob_surface),
         status = ifelse(max_prob >= prediction_params$prob_threshold, "High Confidence", "Ambiguous"))

results_df_filtered <- results_df %>%
  filter(status == "High Confidence")

# Summary of predictions (UPDATE THIS)
cat("\n=== Prediction Summary ===\n")
cat("Total cells predicted:", nrow(results_df), "\n")
cat("High-confidence cells:", nrow(results_df_filtered), "\n")
cat("Filtered out (ambiguous):", nrow(results_df) - nrow(results_df_filtered), "\n\n")
cat("High-confidence class distribution:\n")
print(table(results_df_filtered$predicted_class))
```

```{r}
# --- Define Figure Directory ---
fig_subdir <- file.path(figs_dir, "0.4.1")
if(!dir.exists(fig_subdir)) dir.create(fig_subdir, recursive = TRUE)

# --- Prepare Stats for Plot Labels ---
# Count stats from the full results_df
n_high_conf_core <- sum(results_df$predicted_class == "Core" & results_df$status == "High Confidence")
n_high_conf_surf <- sum(results_df$predicted_class == "Surface" & results_df$status == "High Confidence")
n_ambiguous <- sum(results_df$status == "Ambiguous")

# Create a stats label string
stats_label <- paste0(
  "High Conf. Core: ", n_high_conf_core, "\n",
  "High Conf. Surface: ", n_high_conf_surf, "\n",
  "Ambiguous: ", n_ambiguous
)

# Define readable labels for the config settings (same as previous script)
method_labels <- c(
  "surface_class_radius"   = "Radius Definition",
  "surface_class_nn"       = "KNN Definition",
  "surface_class_clusters" = "Unsupervised Clustering"
)
current_label <- method_labels[classification_method]
if(is.na(current_label)) current_label <- classification_method

# --- Generate Plot ---
p_pred <- ggplot(results_df, aes(x = LD1, fill = predicted_class)) +
  geom_density(alpha = 0.5) +
  # Add lines for visual reference (you might want to adjust x-intercepts based on your data distribution)
  geom_vline(xintercept = c(-1.0, 1.5), linetype = "dashed", color = "black", alpha=0) +
  
  # Add the stats box
  annotate("label", x = Inf, y = Inf, label = stats_label, 
           hjust = 1.1, vjust = 1.1, size = 3.5, 
           fill = "white", alpha = 0.8, color = "black") +
  
  theme_minimal() +
  labs(
    title = "LDA Projection of scRNA-seq Predictions", 
    subtitle = paste0("Model Trained on: ", current_label),
    x = "LD1", 
    y = "Density",
    fill = "Predicted Class"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 10, color = "gray30")
  )

# Print and Save
print(p_pred)

ggsave(
  filename = file.path(fig_subdir, paste0("scRNA_LDA_projection_", classification_method, ".png")),
  plot = p_pred,
  dpi = 300,
  width = 8,
  height = 6
)
```

# Use results_df (all predictions) to show the full distribution
ggplot(results_df, aes(x = LD1, fill = predicted_class)) +
  geom_density(alpha = 0.5) +
  geom_vline(xintercept = c(-1.0, 1.5), linetype = "dashed", color = "black") +
  annotate("text", x = -1.5, y = 0.4, label = "High confidence\nCore", size = 3) +
  annotate("text", x = 2.5, y = 0.4, label = "High confidence\nSurface", size = 3) +
  annotate("text", x = 0.25, y = 0.5, label = "Ambiguous\nregion", size = 3, color = "gray30") +
  theme_minimal() +
  labs(title = "LDA Projection of scRNA-seq Predictions", 
       x = "LD1", 
       y = "Density",
       fill = "Predicted Class")

# Add Predictions to Seurat Object
```{r}
# Add predictions back to the invasive subset
# Initialize all as NA
wts_obj_invasive$predicted_surface_class <- NA
wts_obj_invasive$prob_core <- NA
wts_obj_invasive$LD1_score <- NA

# Add high-confidence predictions only
high_conf_idx <- match(results_df_filtered$cell_id, colnames(wts_obj_invasive))
wts_obj_invasive$predicted_surface_class[high_conf_idx] <- as.character(results_df_filtered$predicted_class)
wts_obj_invasive$prob_core[high_conf_idx] <- results_df_filtered$prob_core
wts_obj_invasive$LD1_score[high_conf_idx] <- results_df_filtered$LD1

# Also add to full Seurat object
wts_obj$predicted_surface_class <- NA
wts_obj$prob_core <- NA
wts_obj$LD1_score <- NA

invasive_cells <- colnames(wts_obj_invasive)
wts_obj$predicted_surface_class[colnames(wts_obj) %in% invasive_cells] <- 
  wts_obj_invasive$predicted_surface_class
wts_obj$prob_core[colnames(wts_obj) %in% invasive_cells] <- 
  wts_obj_invasive$prob_core
wts_obj$LD1_score[colnames(wts_obj) %in% invasive_cells] <- 
  wts_obj_invasive$LD1_score

saveRDS(wts_obj_invasive, file = "janesick_2023/processed/wts_obj_invasive.RDS")

cat("\nPredictions added to Seurat object\n")
cat("High-confidence cells:", sum(!is.na(wts_obj_invasive$predicted_surface_class)), "\n")
cat("Low-confidence cells (NA):", sum(is.na(wts_obj_invasive$predicted_surface_class)), "\n")
```