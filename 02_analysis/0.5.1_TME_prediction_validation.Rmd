---
output:
  pdf_document:
    latex_engine: xelatex
geometry: margin=0.2in
---

# 1. Load files & Libraries
```{r setup, include=FALSE, message = FALSE, warning = FALSE}
# Load config.R
source("config.R") 

# Set root directory using the variable from config
knitr::opts_knit$set(root.dir = data_dir)

# Define figure directory
fig_subdir <- file.path(figs_dir, "0.5.1")
if(!dir.exists(fig_subdir)) dir.create(fig_subdir, recursive = TRUE)

# Local Parameters
p_threshold <- 1e-5

# Load libraries
library(tidyverse)
library(Seurat)
library(dplyr)
library(EnhancedVolcano)
```
```{r}
# Load data
iss_obj_invasive <- readRDS("janesick_2023/processed/iss_obj_invasive.RDS")
scRNA_invasive <- readRDS('janesick_2023/processed/wts_obj_invasive.RDS')
shared_genes <- readRDS("janesick_2023/processed/shared_genes.RDS")
train_genes <- readRDS("janesick_2023/processed/train_genes.RDS")

# Filter both objects to shared genes to ensure alignment
genes_to_keep <- intersect(rownames(scRNA_invasive), intersect(rownames(iss_obj_invasive), shared_genes))
scRNA_invasive   <- subset(scRNA_invasive, features = genes_to_keep)
iss_obj_invasive <- subset(iss_obj_invasive, features = genes_to_keep)
```

# 2. DGE Analysis
```{r}
# 1. scRNA-seq (WTD) Analysis
Idents(scRNA_invasive) <- scRNA_invasive$predicted_surface_class

# Test Surface vs Core (positive log2FC = higher in Surface)
markers_WTD <- FindMarkers(
  scRNA_invasive,
  ident.1 = "Surface",
  ident.2 = "Core",
  test.use = validation_params$marker_method,
  logfc.threshold = 0.25,
  min.pct = 0,
  verbose = FALSE
)

# Save results to dataframe
res_WTD <- markers_WTD %>%
  rownames_to_column("gene") %>%
  dplyr::rename(
    log2FoldChange_WTD = avg_log2FC,
    pval_WTD = p_val,
    padj_WTD = p_val_adj
  ) %>%
  arrange(padj_WTD)

# 2. ISS Analysis
Idents(iss_obj_invasive) <- iss_obj_invasive@meta.data[[classification_method]]

markers_ISS <- FindMarkers(
  iss_obj_invasive,
  slot = "counts",
  ident.1 = "Surface",
  ident.2 = "Core",
  test.use = validation_params$marker_method,
  logfc.threshold = 0.25,
  min.pct = 0,
  verbose = FALSE
)

# Save results to dataframe
res_ISS <- markers_ISS %>%
  rownames_to_column("gene") %>%
  dplyr::rename(
    log2FoldChange_ISS = avg_log2FC,
    pval_ISS = p_val,
    padj_ISS = p_val_adj
  ) %>%
  arrange(padj_ISS)

# 3. Save Results
write.csv(res_ISS, file.path(data_dir, "janesick_2023/processed/DGE_ISS_Surface_vs_Core.csv"), row.names = FALSE)
write.csv(res_WTD, file.path(data_dir, "janesick_2023/processed/DGE_WTD_Surface_vs_Core.csv"), row.names = FALSE)
```

```{r}
# Merge Results
comparison_full <- inner_join(
  res_ISS %>% dplyr::select(gene, log2FoldChange_ISS, padj_ISS),
  res_WTD %>% dplyr::select(gene, log2FoldChange_WTD, padj_WTD),
  by = "gene"
) %>%
  mutate(
    sig_ISS = ifelse(padj_ISS < p_threshold, "Significant", "Not_Significant"),
    sig_WTD = ifelse(padj_WTD < p_threshold, "Significant", "Not_Significant"),
    both_sig = paste(sig_ISS, sig_WTD, sep = " / "),
    training_gene = gene %in% train_genes
  )

# Split into training and validation sets
comparison_training   <- comparison_full %>% filter(training_gene == TRUE)
comparison_validation <- comparison_full %>% filter(training_gene == FALSE)

cat("Total genes:", nrow(comparison_full), "| Training:", nrow(comparison_training), "| Validation:", nrow(comparison_validation), "\n")
```

```{r}
# Calculate Spearman Correlations
cor_train <- cor(comparison_training$log2FoldChange_ISS, comparison_training$log2FoldChange_WTD, use = "complete.obs")
cor_valid <- cor(comparison_validation$log2FoldChange_ISS, comparison_validation$log2FoldChange_WTD, use = "complete.obs")

cat("Spearman Correlation - Training:  ", round(cor_train, 3), "\n")
cat("Spearman Correlation - Validation:", round(cor_valid, 3), "\n")
```

# Plots
```{r}
# Define labels
method_labels <- c("surface_class_radius" = "Radius", "surface_class_nn" = "KNN", "surface_class_clusters" = "Cluster")
curr_label <- method_labels[classification_method]
if(is.na(curr_label)) curr_label <- classification_method

# 1. Training Genes
p1 <- ggplot(comparison_training, aes(x = log2FoldChange_ISS, y = log2FoldChange_WTD)) +
  geom_point(aes(color = both_sig), alpha = 0.6, size = 2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray40") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  geom_abline(slope = 1, intercept = 0, linetype = "dotted", color = "blue") +
  scale_color_manual(values = c(
    "Not_Significant / Not_Significant" = "gray70",
    "Significant / Not_Significant" = "orange",
    "Not_Significant / Significant" = "purple",
    "Significant / Significant" = "red"
  )) +
  labs(
    title = paste0("Training Genes: ISS vs scRNA-seq (", curr_label, ")"),
    subtitle = paste0("Spearman rho = ", round(cor_train, 3), " (n=", nrow(comparison_training), ")"),
    x = "log2 Fold Change (ISS)", y = "log2 Fold Change (scRNA-seq)", color = "Significance"
  ) +
  theme_bw() + theme(legend.position = "bottom")

print(p1)
ggsave(file.path(fig_subdir, paste0("DGE_correlation_TRAINING_", classification_method, ".png")), p1, width = 7, height = 7)

# 2. Validation Genes
p2 <- ggplot(comparison_validation, aes(x = log2FoldChange_ISS, y = log2FoldChange_WTD)) +
  geom_point(aes(color = both_sig), alpha = 0.6, size = 2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray40") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  geom_abline(slope = 1, intercept = 0, linetype = "dotted", color = "blue") +
  scale_color_manual(values = c(
    "Not_Significant / Not_Significant" = "gray70",
    "Significant / Not_Significant" = "orange",
    "Not_Significant / Significant" = "purple",
    "Significant / Significant" = "red"
  )) +
  labs(
    title = paste0("Validation Genes: ISS vs scRNA-seq (", curr_label, ")"),
    subtitle = paste0("Spearman rho = ", round(cor_valid, 3), " (n=", nrow(comparison_validation), ")"),
    x = "log2 Fold Change (ISS)", y = "log2 Fold Change (scRNA-seq)", color = "Significance"
  ) +
  theme_bw() + theme(legend.position = "bottom")

print(p2)
ggsave(file.path(fig_subdir, paste0("DGE_correlation_VALIDATION_", classification_method, ".png")), p2, width = 7, height = 7)
```

```{r}
EnhancedVolcano(res_ISS, lab = res_ISS$gene, x = "log2FoldChange_ISS", y = "padj_ISS", pCutoff = p_threshold, title = "ISS Volcano")
EnhancedVolcano(res_WTD, lab = res_WTD$gene, x = "log2FoldChange_WTD", y = "padj_WTD", pCutoff = p_threshold, title = "scRNA Volcano")
```

# Plot of all genes comparing core vs surface. where x axis is surface expression level and y axis is core expression level. 
```{r}
# Prepare Average Expression Data
# 1. ISS: Subset & Average
iss_subset <- subset(iss_obj_invasive, cells = colnames(iss_obj_invasive)[!is.na(iss_obj_invasive[[classification_method]])])
Idents(iss_subset) <- classification_method
avg_iss <- AverageExpression(iss_subset, assays = "RNA")$RNA %>% 
  as.data.frame() %>%
  dplyr::rename(iss_core = Core, iss_surface = Surface)

# 2. scRNA: Subset & Average
wts_subset <- subset(scRNA_invasive, subset = predicted_surface_class %in% c("Surface", "Core"))
Idents(wts_subset) <- wts_subset$predicted_surface_class
avg_wts <- AverageExpression(wts_subset, assays = "RNA")$RNA %>% 
  as.data.frame() %>%
  dplyr::rename(scRNA_core = Core, scRNA_surface = Surface)

# 3. Merge & Annotate
plot_data_clean <- merge(avg_iss, avg_wts, by = "row.names") %>%
  dplyr::rename(gene = Row.names) %>%
  left_join(comparison_full %>% dplyr::select(gene, padj_ISS, padj_WTD, training_gene), by = "gene")

# Split for plotting
plot_data_training   <- plot_data_clean %>% filter(training_gene == TRUE)
plot_data_validation <- plot_data_clean %>% filter(training_gene == FALSE)
```
```{r}
# Function for consistent dark-theme plots
make_clean_plot <- function(df, x_col, y_col, p_col, title) {
  ggplot(df, aes(x = .data[[x_col]], y = .data[[y_col]], color = -log10(.data[[p_col]]))) +
    geom_point(alpha = 0.7, size = 1.2) +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "white") +
    scale_x_log10() + scale_y_log10() +
    scale_color_viridis_c(option = "magma", direction = -1) +
    labs(title = title, x = "Surface Expression", y = "Core Expression", color = "-log10(padj)") +
    theme(
      panel.background = element_rect(fill = "grey50"),
      plot.background = element_rect(fill = "grey50"),
      panel.grid.major = element_line(color = "grey50"),
      panel.grid.minor = element_line(color = "grey55"),
      text = element_text(color = "white"),
      axis.text = element_text(color = "white"),
      legend.background = element_rect(fill = "grey50"),
      legend.text = element_text(color = "white")
    )
}

# Generate Plots
p_train_iss <- make_clean_plot(plot_data_training, "iss_surface", "iss_core", "padj_ISS", "ISS (Training)")
p_train_sc  <- make_clean_plot(plot_data_training, "scRNA_surface", "scRNA_core", "padj_WTD", "scRNA (Training)")
p_val_iss   <- make_clean_plot(plot_data_validation, "iss_surface", "iss_core", "padj_ISS", "ISS (Validation)")
p_val_sc    <- make_clean_plot(plot_data_validation, "scRNA_surface", "scRNA_core", "padj_WTD", "scRNA (Validation)")

# Combine with Patchwork
(p_train_iss + p_train_sc) / (p_val_iss + p_val_sc)
```
