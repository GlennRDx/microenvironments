---
title: "0.7.2_pseudobulk_datasets"
output: html_document
---
```{r}
# 1. Setup and Load Data
library(Seurat)
library(dplyr)
# Load your object with predictions
wts_obj <- readRDS("/Users/glero527/Documents/microenvironments/01_data/janesick_2023/processed/wts_obj_processed_predicted.RDS")

output_dir <- "/Users/glero527/Documents/microenvironments/01_data/janesick_2023/processed/pseudobulk_files/"
# Create the directory if it doesn't exist
dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)

Idents(wts_obj) <- "microenv_prediction"
```


```{r}
# 2. Prepare the Matrix
if(exists("JoinLayers")){
  wts_obj <- JoinLayers(wts_obj)
}
full_count_matrix <- GetAssayData(wts_obj, assay = "RNA", layer = "counts")

# 3. Set up the loop
ratios <- seq(0, 1, by = 0.1) 
total_cells <- 500 
cells_surface <- WhichCells(wts_obj, idents = "Surface")
cells_core <- WhichCells(wts_obj, idents = "Core")

# We will still track truth in a single file for your reference
true_proportions <- data.frame(Sample = character(), True_Surface = double(), stringsAsFactors = F)

set.seed(123) 

for (r in ratios) {
  # Calculate N cells
  n_surf <- round(total_cells * r)
  n_core <- total_cells - n_surf
  
  if(length(cells_surface) < n_surf || length(cells_core) < n_core) {
    warning(paste("Not enough cells for ratio", r))
    next
  }
  
  # Randomly sample
  samp_surf <- sample(cells_surface, n_surf)
  samp_core <- sample(cells_core, n_core)
  selected_cells <- c(samp_surf, samp_core)
  
  # Create Pseudobulk
  subset_mat <- full_count_matrix[, selected_cells]
  mix_vector <- rowSums(subset_mat)
  
  # Define Sample Name
  sample_name <- paste0("Mix_Surf_", r * 100)
  
  # --- FORMAT & SAVE SINGLE FILE ---
  # Create a dataframe with "Gene" as the first column (Required for CIBERSORT)
  single_sample_df <- data.frame(Gene = rownames(subset_mat), 
                                 Count = mix_vector, 
                                 stringsAsFactors = FALSE)
  
  # Rename the count column to the sample name
  colnames(single_sample_df)[2] <- sample_name
  
  # Save as .txt file in the specific folder
  write.table(single_sample_df, 
              file = file.path(output_dir, paste0(sample_name, ".txt")), 
              sep = "\t", 
              quote = FALSE, 
              row.names = FALSE)
  
  # Store truth for the answer key
  true_proportions <- rbind(true_proportions, data.frame(Sample = sample_name, True_Surface = r))
}

# Save the "Answer Key" separately
saveRDS(true_proportions, "/Users/glero527/Documents/microenvironments/01_data/janesick_2023/processed/pseudobulk_truth.RDS")

print(paste("Done! Files generated in:", output_dir))
```

```{r}
# Define the path to one specific file
file_path <- "/Users/glero527/Documents/microenvironments/01_data/janesick_2023/processed/pseudobulk_files/Mix_Surf_50.txt"

# Read it in
mix_50 <- read.table(file_path, header = TRUE, sep = "\t", check.names = FALSE)

# View the first few rows
head(mix_50)
```

