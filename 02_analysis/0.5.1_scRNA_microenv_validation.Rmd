---
output:
  pdf_document:
    latex_engine: xelatex
geometry: margin=0.2in
---

# 1. Load files & Libraries
```{r setup, include=FALSE, message = FALSE, warning = FALSE}
# Load config.R
source("config.R") 

# Set root directory using the variable from config
knitr::opts_knit$set(root.dir = data_dir)

# Define figure directory
fig_subdir <- file.path(figs_dir, "0.5.1")
if(!dir.exists(fig_subdir)) dir.create(fig_subdir, recursive = TRUE)

# Local Parameters
p_threshold <- 1e-5

# Load libraries
library(tidyverse)
library(Seurat)
library(dplyr)
library(EnhancedVolcano)
```

```{r}
# Load data
iss_obj_invasive <- readRDS("janesick_2023/processed/iss_obj_invasive.RDS")
scRNA_invasive <- readRDS('janesick_2023/processed/wts_obj_invasive.RDS')

# Load gene lists
shared_genes <- readRDS("janesick_2023/processed/shared_genes.RDS")
train_genes <- readRDS("janesick_2023/processed/train_genes.RDS")
val_genes <- setdiff(shared_genes, train_genes)
```

# 2. DGE Analysis
1. min.pct (filters out genes that are expressed in fewer than a specific percentage of cells in both groups) was set to 0: Can lead to significant p-values for genes that are only expressed in 1 or 2 cells: not v useful as "markers" for a whole population.

2. logfc.threshold (filters out genes that do not meet a minimum average fold-change difference between groups) was set to 0: Lead to p-value inflation, where tiny, biologically meaningless differences become statistically significant due to the large number of cells
```{r}
# DGE Analysis
# 1. scRNA-seq (WTD) Analysis
Idents(scRNA_invasive) <- scRNA_invasive$microenv_lda_val

# Test Surface vs Core (positive log2FC = higher in Surface)
dge_wts <- FindMarkers(
  scRNA_invasive,
  slot = "counts",
  ident.1 = "Surface",
  ident.2 = "Core",
  test.use = validation_params$marker_method,
  logfc.threshold = 0,
  min.pct = 0,
  verbose = FALSE
)

# 2. ISS Analysis
iss_obj_invasive <- iss_obj_invasive[shared_genes,]
Idents(iss_obj_invasive) <- iss_obj_invasive@meta.data[[classification_method]]

dge_iss <- FindMarkers(
  iss_obj_invasive,
  slot = "counts",
  ident.1 = "Surface",
  ident.2 = "Core",
  test.use = validation_params$marker_method,
  logfc.threshold = 0,
  min.pct = 0,
  verbose = FALSE
)
```

```{r}
# DGE Results Table
dge_iss_merging <- dge_iss[,c(2,5)]
names(dge_iss_merging)[c(1,2)] <- c("Log2FoldChange_ISS", "p-adj_ISS")

dge_scRNA_merging <- dge_wts[,c(2,5)]
names(dge_scRNA_merging)[c(1,2)] <- c("Log2FoldChange_scRNA", "p-adj_scRNA")

dge_full <- merge(dge_scRNA_merging, dge_iss_merging, by = 0)

rownames(dge_full) <- dge_full$Row.names
dge_full$Row.names <- NULL

dge_full$ISS_result <- ifelse(dge_full$`p-adj_ISS` < 0.05 & dge_full$Log2FoldChange_ISS > 1, "Up",
               ifelse(dge_full$`p-adj_ISS` < 0.05 & dge_full$Log2FoldChange_ISS < -1, "Down", 
                 "Other"))

dge_full$scRNA_result <- ifelse(dge_full$`p-adj_scRNA` < 0.05 & dge_full$Log2FoldChange_scRNA > 1, "Up",
               ifelse(dge_full$`p-adj_scRNA` < 0.05 & dge_full$Log2FoldChange_scRNA < -1, "Down", 
                 "Other"))

dge_full$train <- rownames(dge_full) %in% train_genes # add boolean column denoting if a gene was used in training

dge_full$point_col <- ifelse(dge_full$ISS_result == "Other" & dge_full$scRNA_result == "Other", "black",
                      ifelse(dge_full$ISS_result == "Other" & dge_full$scRNA_result != "Other", "orange",
                      ifelse(dge_full$ISS_result != "Other" & dge_full$scRNA_result == "Other", "purple", "red")))
```

```{r}
# plot scRNA logFC against the ISS logfc (training and validation genes separately)
lims <- c(-5,5)

# TRAINING PLOT
plot(dge_full[dge_full$train,]$Log2FoldChange_ISS, 
     dge_full[dge_full$train,]$Log2FoldChange_scRNA,
     pch = 16,
     cex = 0.75,
     xlim = lims,
     ylim = lims,
     col = dge_full[dge_full$train,]$point_col,
     xlab = "ISS Log2FC",
     ylab = "scRNA Log2FC",
     main = "Training Genes")
mtext(paste("Genes:", as.character(length(rownames(dge_full[dge_full$train,]))), "     Thresholds: |Log2FC| > 1, p-adj < 0.05"), line = 0.2)
abline(a = 0, b = 1, col = "red", lwd = 2, lty = 2)
abline(v = 0, col = "black", lty = 2)
abline(h = 0, col = "black", lty = 2)

# VALIDATION PLOT
plot(dge_full[!dge_full$train,]$Log2FoldChange_ISS, 
     dge_full[!dge_full$train,]$Log2FoldChange_scRNA,
     pch = 16,
     cex = 0.75,
     col = dge_full[!dge_full$train,]$point_col,
     xlim = lims,
     ylim = lims,
     xlab = "ISS Log2FC",
     ylab = "scRNA Log2FC",
     main = "Validation Genes")
mtext(paste("Genes:", as.character(length(rownames(dge_full[!dge_full$train,]))), "     Thresholds: |Log2FC| > 1, p-adj < 0.05"), line = 0.2)
abline(a = 0, b = 1, col = "red", lwd = 2, lty = 2)
abline(v = 0, col = "black", lty = 2)
abline(h = 0, col = "black", lty = 2)
```


```{r}
# --- ISS Data ---
iss_data <- GetAssayData(iss_obj_invasive, layer = "data")
cells_surf_iss <- colnames(iss_obj_invasive)[iss_obj_invasive$surface_class_radius == "Surface"]
cells_core_iss <- colnames(iss_obj_invasive)[iss_obj_invasive$surface_class_radius == "Core"]

iss_means <- data.frame(
  gene = rownames(iss_data),
  mean_surf = rowMeans(iss_data[, cells_surf_iss]),
  mean_core = rowMeans(iss_data[, cells_core_iss])
) %>% filter(gene %in% shared_genes)

# --- scRNA-seq Data ---
wts_data <- GetAssayData(scRNA_invasive, layer = "data")
cells_surf_wts <- colnames(scRNA_invasive)[scRNA_invasive$microenv_lda_val == "Surface"]
cells_core_wts <- colnames(scRNA_invasive)[scRNA_invasive$microenv_lda_val == "Core"]

wts_means <- data.frame(
  gene = rownames(wts_data),
  mean_surf = rowMeans(wts_data[, cells_surf_wts]),
  mean_core = rowMeans(wts_data[, cells_core_wts])
) %>% filter(gene %in% shared_genes)
```
































```{r}
# Setup 2x2 grid
par(mfrow = c(2, 2)) 

# --- Helper function for consistent plotting ---
plot_means <- function(df, gene_list, title_text) {
  # Subset data
  df_sub <- df %>% filter(gene %in% gene_list)
  
  # Determine limits for square plot
  lims <- c(0, max(c(df_sub$mean_surf, df_sub$mean_core)))
  
  # Plot
  plot(x = df_sub$mean_surf, 
       y = df_sub$mean_core,
       pch = 19, 
       col = rgb(0, 0, 0, 0.5), # Black with transparency
       xlim = lims, ylim = lims,
       xlab = "Mean Surface Expression",
       ylab = "Mean Core Expression",
       main = title_text)
  
  # Add Identity Line (x=y)
  abline(a = 0, b = 1, col = "red", lty = 2, lwd = 1.5)
  
  # Add grid
  grid()
}

# 1. ISS - Training Genes
plot_means(iss_means, train_genes, "ISS: Training Genes")

# 2. ISS - Validation Genes
plot_means(iss_means, val_genes, "ISS: Validation Genes")

# 3. WTS - Training Genes
plot_means(wts_means, train_genes, "scRNA-seq: Training Genes")

# 4. WTS - Validation Genes
plot_means(wts_means, val_genes, "scRNA-seq: Validation Genes")
```


# Plot of all genes comparing core vs surface. where x axis is surface expression level and y axis is core expression level. 
```{r}
# Prepare Average Expression Data
# 1. ISS: Subset & Average
iss_subset <- subset(iss_obj_invasive, cells = colnames(iss_obj_invasive)[!is.na(iss_obj_invasive[[classification_method]])])
Idents(iss_subset) <- classification_method
avg_iss <- AverageExpression(iss_subset, assays = "RNA")$RNA %>% 
  as.data.frame() %>%
  dplyr::rename(iss_core = Core, iss_surface = Surface)

# 2. scRNA: Subset & Average
wts_subset <- subset(scRNA_invasive, subset = predicted_surface_class %in% c("Surface", "Core"))
Idents(wts_subset) <- wts_subset$predicted_surface_class
avg_wts <- AverageExpression(wts_subset, assays = "RNA")$RNA %>% 
  as.data.frame() %>%
  dplyr::rename(scRNA_core = Core, scRNA_surface = Surface)

# 3. Merge & Annotate
plot_data_clean <- merge(avg_iss, avg_wts, by = "row.names") %>%
  dplyr::rename(gene = Row.names) %>%
  left_join(comparison_full %>% dplyr::select(gene, padj_ISS, padj_WTD, training_gene), by = "gene")

# Split for plotting
plot_data_training   <- plot_data_clean %>% filter(training_gene == TRUE)
plot_data_validation <- plot_data_clean %>% filter(training_gene == FALSE)
```
```{r}
# Function for consistent dark-theme plots
make_clean_plot <- function(df, x_col, y_col, p_col, title) {
  ggplot(df, aes(x = .data[[x_col]], y = .data[[y_col]], color = -log10(.data[[p_col]]))) +
    geom_point(alpha = 0.7, size = 1.2) +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "white") +
    scale_x_log10() + scale_y_log10() +
    scale_color_viridis_c(option = "magma", direction = -1) +
    labs(title = title, x = "Surface Expression", y = "Core Expression", color = "-log10(padj)") +
    theme(
      panel.background = element_rect(fill = "grey50"),
      plot.background = element_rect(fill = "grey50"),
      panel.grid.major = element_line(color = "grey50"),
      panel.grid.minor = element_line(color = "grey55"),
      text = element_text(color = "white"),
      axis.text = element_text(color = "white"),
      legend.background = element_rect(fill = "grey50"),
      legend.text = element_text(color = "white")
    )
}

# Generate Plots
p_train_iss <- make_clean_plot(plot_data_training, "iss_surface", "iss_core", "padj_ISS", "ISS (Training)")
p_train_sc  <- make_clean_plot(plot_data_training, "scRNA_surface", "scRNA_core", "padj_WTD", "scRNA (Training)")
p_val_iss   <- make_clean_plot(plot_data_validation, "iss_surface", "iss_core", "padj_ISS", "ISS (Validation)")
p_val_sc    <- make_clean_plot(plot_data_validation, "scRNA_surface", "scRNA_core", "padj_WTD", "scRNA (Validation)")

# Combine with Patchwork
(p_train_iss + p_train_sc) / (p_val_iss + p_val_sc)
```
test