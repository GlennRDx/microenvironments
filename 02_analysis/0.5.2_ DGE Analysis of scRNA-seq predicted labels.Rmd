---
output:
  pdf_document:
    latex_engine: xelatex
geometry: margin=0.2in
---

# 1. Load libraries and data
```{r setup, include=FALSE, message = FALSE, warning = FALSE}
# Load config.R
source("config.R") 

# Set root directory using the variable from config
knitr::opts_knit$set(root.dir = data_dir)

# Define figure directory
fig_subdir <- file.path(figs_dir, "0.5.2")
if(!dir.exists(fig_subdir)) dir.create(fig_subdir, recursive = TRUE)

library(Seurat)
library(dplyr)
library(EnhancedVolcano)
library(topGO)
library(org.Hs.eg.db)
library(ggplot2)
```

```{r}
# Load data
wts_obj <- readRDS("janesick_2023/processed/wts_obj_processed_predicted.RDS")
```

# 2. DGE Analysis
```{r}
Idents(wts_obj) <- "predicted_surface_class"

# Find markers comparing Surface (ident.1) vs Core (ident.2)
dge_results <- FindMarkers(
  object = wts_obj,
  ident.1 = "Surface",
  ident.2 = "Core",
  test.use = "negbinom",
  logfc.threshold = 0.25,
  min.pct = 0.1
)

# Filter for statistically significant genes
dge_sig <- dge_results %>%
  filter(p_val_adj < 0.05) %>%
  arrange(desc(avg_log2FC))
```

# 3. Volcano Plot
```{r}
# Create Volcano Plot
p_volc <- EnhancedVolcano(
  toptable = dge_results,
  lab = rownames(dge_results),
  x = 'avg_log2FC',
  y = 'p_val_adj',
  title = 'Surface vs. Core Invasive Tumor',
  subtitle = 'Positive FC = Surface | Negative FC = Core',
  pCutoff = 0.05,
  FCcutoff = 0.5,
  pointSize = 2.0,
  labSize = 4.0
)

print(p_volc)
```

# 4. GO enrichment
```{r, fig.width=7.87*1.25, fig.height = 6.5*1.25, dpi=300, dev='tiff', out.width='100%'}
# 1. Get list of significant gene names
genes_to_test <- rownames(dge_sig)

# 2. Convert Gene Symbols to Entrez IDs (required for clusterProfiler)
gene_ids <- bitr(
  genes_to_test, 
  fromType = "SYMBOL", 
  toType = "ENTREZID", 
  OrgDb = org.Hs.eg.db
)

# 3. Run GO Enrichment (Biological Process)
go_results <- enrichGO(
  gene = gene_ids$ENTREZID,
  OrgDb = org.Hs.eg.db,
  ont = "BP",           # Biological Process
  pAdjustMethod = "BH",
  pvalueCutoff = 0.05,
  readable = TRUE       # Converts IDs back to symbols in output
)

# 4. Plot top 15 pathways
dotplot(go_results, showCategory = 15) + 
  ggtitle("GO Enrichment: Surface & Core DGE")
```

# topGO
```{r}
# 1. Define the Gene Universe and the "Interesting" genes
# topGO needs a named vector where names are gene symbols and values are p-values
all_genes <- dge_results$p_val_adj
names(all_genes) <- rownames(dge_results)

# 2. Create a selection function (identifies significant genes)
topDiffGenes <- function(allScore) {
  return(allScore < 0.05)
}

# 3. Initialize topGOdata object
# Using 'mapping = org.Hs.eg.db' and 'ID = symbol' to match Seurat output
go_data <- new("topGOdata",
  ontology = "BP",              # Biological Process
  allGenes = all_genes,
  geneSel = topDiffGenes,
  annot = annFUN.org,
  mapping = "org.Hs.eg.db",
  ID = "symbol"                 # Assumes Seurat rownames are symbols
)

# 4. Run Statistical Tests
# 'classic' is standard; 'elim' is more conservative/specific to GO hierarchy
result_fisher <- runTest(go_data, algorithm = "classic", statistic = "fisher")

# 5. Extract Results Table
go_results_table <- GenTable(
  go_data, 
  classicFisher = result_fisher, 
  orderBy = "classicFisher", 
  ranksOf = "classicFisher", 
  topNodes = 20
)

# 6. Visualization (Manual ggplot2 barplot)
# Clean the p-value column (sometimes has < signs)
go_results_table$classicFisher <- as.numeric(gsub("<", "", go_results_table$classicFisher))

ggplot(go_results_table, aes(x = reorder(Term, -classicFisher), y = -log10(classicFisher))) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  labs(
    title = "topGO Enrichment: Surface vs Core",
    x = "GO Term",
    y = "-log10(p-value)"
  ) +
  theme_minimal()
```