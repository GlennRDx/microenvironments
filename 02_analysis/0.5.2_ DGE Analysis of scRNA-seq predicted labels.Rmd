---
output:
  pdf_document:
    latex_engine: xelatex
geometry: margin=0.2in
---

# 1. Load libraries and data
```{r setup, include=FALSE, message = FALSE, warning = FALSE}
# Load config.R
source("config.R") 

# Set root directory using the variable from config
knitr::opts_knit$set(root.dir = data_dir)

# Define figure directory
fig_subdir <- file.path(figs_dir, "0.5.2")
if(!dir.exists(fig_subdir)) dir.create(fig_subdir, recursive = TRUE)

library(Seurat)
library(dplyr)
library(EnhancedVolcano)
library(clusterProfiler)
library(topGO)
library(org.Hs.eg.db)
library(ggplot2)
```

```{r}
# Load data
wts_obj <- readRDS("janesick_2023/processed/wts_obj_processed_predicted.RDS")
```

# 2. DGE Analysis
```{r}
Idents(wts_obj) <- "predicted_surface_class"

# Find markers comparing Surface (ident.1) vs Core (ident.2)
dge_results_negbinom <- FindMarkers(
  object = wts_obj,
  ident.1 = "Surface",
  ident.2 = "Core",
  test.use = "negbinom",
  logfc.threshold = 0.1,
  min.pct = 0.1
)

dge_results_wilcoxon <- FindMarkers(
  object = wts_obj,
  ident.1 = "Surface",
  ident.2 = "Core",
  test.use = "wilcox",
  logfc.threshold = 0.1,
  min.pct = 0.1
)

# Filter for statistically significant genes
dge_sig_negbinom <- dge_results_negbinom %>%
  filter(p_val_adj < 0.05) %>%
  arrange(desc(avg_log2FC))

dge_sig_wilcoxon <- dge_results_wilcoxon %>%
  filter(p_val_adj < 0.05) %>%
  arrange(desc(avg_log2FC))
```

# 3. Volcano Plot

```{r}
# Plot
plot(dge_results_negbinom$avg_log2FC, -log10(dge_results_negbinom$p_val_adj),
     main = "Surface vs. Core (negbinom)", 
     xlab = "log2 Fold Change", 
     ylab = "-log10(adj p-value)",
     pch = 1, cex = 0.5)   

# Threshold lines
abline(h = -log10(1e-50), col = "black", lty = 2) # Horizontal p-adj line
abline(v = c(-0.5, 0.5), col = "black", lty = 2) # Vertical FC lines

plot(dge_results_wilcoxon$avg_log2FC, -log10(dge_results_wilcoxon$p_val_adj),
     main = "Surface vs. Core (wilcoxon)", 
     xlab = "log2 Fold Change", 
     ylab = "-log10(adj p-value)",
     pch = 1, cex = 0.5)   

# Threshold lines
abline(h = -log10(1e-50), col = "black", lty = 2) # Horizontal p-adj line
abline(v = c(-0.5, 0.5), col = "black", lty = 2) # Vertical FC lines
```

# 4. GO enrichment
```{r, fig.width=7.87*2, fig.height = 6.5*2, dpi=300, dev='tiff', out.width='100%'}
# Significant gene names
genes_to_test <- rownames(dge_sig_negbinom)

# Convert Gene Symbols to Entrez IDs
gene_ids <- bitr(
  genes_to_test, 
  fromType = "SYMBOL", 
  toType = "ENTREZID", 
  OrgDb = org.Hs.eg.db
)

# 3. GO Enrichment
go_results <- enrichGO(
  gene = gene_ids$ENTREZID,
  OrgDb = org.Hs.eg.db,
  ont = "BP",
  pAdjustMethod = "BH",
  pvalueCutoff = 0.05,
  readable = TRUE       # Converts IDs back to symbols in output
)

# 4. Plot pathways
enrichplot::dotplot(go_results, showCategory = 100)
```
# topGO
```{r}
# Define the Gene Universe (names = gene symb, values = padj)
all_genes <- dge_results_negbinom$p_val_adj
names(all_genes) <- rownames(dge_results_negbinom)

# Create a selection function (identifies significant genes)
topDiffGenes <- function(allScore) {
  return(allScore < 0.05)
}

# Create topGOdata object
go_data <- new("topGOdata",
  ontology = "BP",
  allGenes = all_genes,
  geneSel = topDiffGenes,
  annot = annFUN.org,
  mapping = "org.Hs.eg.db",
  ID = "symbol"
)

# 4. Run fisher test
result_fisher <- runTest(go_data, algorithm = "classic", statistic = "fisher")

# 5. Results Table
go_results_table <- GenTable(
  go_data, 
  classicFisher = result_fisher, 
  orderBy = "classicFisher", 
  ranksOf = "classicFisher", 
  topNodes = 50
)
```